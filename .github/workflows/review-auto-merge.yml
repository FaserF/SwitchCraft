name: Auto Merge (Review Listener)

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  checks: read
  issues: read
  actions: read

jobs:
  auto-merge-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check Criteria and Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Processing PR #$PR_NUMBER for Auto-Merge (Trigger: Review)..."

          # 1. Check CI Status (Must manually verify CI Orchestrator passed)
          echo "Checking CI Status for PR #$PR_NUMBER..."
          PR_HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          CI_CONCLUSION=$(gh run list --commit "$PR_HEAD_SHA" --workflow "CI Orchestrator" --json conclusion --jq '.[0].conclusion')

          if [[ "$CI_CONCLUSION" != "success" ]]; then
             echo "::notice::CI Orchestrator is not 'success' (current: $CI_CONCLUSION). Skipping merge."
             exit 0
          fi
          echo "CI Orchestrator passed ($CI_CONCLUSION)."

          # 2. Check PR Author Permissions
          PR_AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')
          if [[ "$PR_AUTHOR" == *"[bot]" ]]; then
             echo "PR Author is a Bot. Allowed."
          else
             PERM=$(gh api "repos/$REPO/collaborators/$PR_AUTHOR/permission" --jq '.permission')
             if [[ "$PERM" == "admin" || "$PERM" == "maintain" || "$PERM" == "write" ]]; then
                 echo "Author has trusted permission ($PERM). Allowed."
             else
                 echo "::notice::PR Author ($PR_AUTHOR) does not have sufficient permissions. Skipping."
                 exit 0
             fi
          fi

          # 3. Check Coderabbit Status
          echo "Checking Coderabbit status..."
          IS_APPROVED=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" --jq '.[] | select(.user.login == "coderabbitai[bot]" and .state == "APPROVED") | .state' | head -n 1)
          HAS_SKIP_COMMENT=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.user.login == "coderabbitai[bot]" and (.body | test("skip"; "i"))) | .id' | head -n 1)

          if [[ -n "$IS_APPROVED" ]]; then
             echo "Coderabbit APPROVED."
          elif [[ -n "$HAS_SKIP_COMMENT" ]]; then
             echo "Coderabbit SKIPPED review."
          else
             echo "::notice::Coderabbit has not approved or skipped yet. Waiting."
             exit 0
          fi

          # 4. Attempt Merge
          gh pr merge "$PR_NUMBER" --merge --auto --delete-branch
