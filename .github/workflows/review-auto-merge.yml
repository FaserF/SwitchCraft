name: Auto Merge (Review Listener)

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  checks: read
  issues: write
  actions: read

jobs:
  auto-merge-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check Criteria and Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Processing PR #$PR_NUMBER for Auto-Merge (Trigger: Review)..."

          # 0. Check for no-auto-merge label
          echo "Checking for no-auto-merge label..."
          HAS_NO_AUTO_MERGE=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[] | select(.name == "no-auto-merge") | .name' | head -n 1)
          if [[ -n "$HAS_NO_AUTO_MERGE" ]]; then
             echo "::notice::PR has 'no-auto-merge' label. Skipping auto-merge."
             # Check if comment already exists to avoid duplicates
             COMMENT_EXISTS=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.body | contains("Auto-Merge Skipped") and contains("no-auto-merge")) | .id' | head -n 1)
             if [[ -z "$COMMENT_EXISTS" ]]; then
               # Post a comment explaining why auto-merge was skipped (only if not already posted)
               # Use heredoc to preserve multi-line message and avoid YAML parsing issues
               BODY=$'ðŸš« **Auto-Merge Skipped**\n\nThis PR has the `no-auto-merge` label. Auto-merge was not executed.\n\nTo enable auto-merge, please remove the `no-auto-merge` label.'
               gh pr comment "$PR_NUMBER" --body "$BODY"
             fi
             exit 0
          fi
          echo "No 'no-auto-merge' label found. Proceeding..."

          # 1. Check CI Status (Must manually verify CI Orchestrator passed)
          echo "Checking CI Status for PR #$PR_NUMBER..."
          PR_HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          # Use workflow file name instead of display name
          CI_CONCLUSION=$(gh run list --commit "$PR_HEAD_SHA" --workflow "ci-orchestrator.yml" --json conclusion --jq '.[0].conclusion' || echo "null")

          if [[ "$CI_CONCLUSION" == "null" || "$CI_CONCLUSION" == "" ]]; then
             echo "::notice::CI Orchestrator workflow not found or not yet run. Skipping merge."
             exit 0
          fi

          if [[ "$CI_CONCLUSION" != "success" ]]; then
             echo "::notice::CI Orchestrator is not 'success' (current: $CI_CONCLUSION). Skipping merge."
             exit 0
          fi
          echo "CI Orchestrator passed ($CI_CONCLUSION)."

          # 2. Check PR Author Permissions
          PR_AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')
          if [[ "$PR_AUTHOR" == *"[bot]" ]]; then
             echo "PR Author is a Bot. Allowed."
          else
             PERM=$(gh api "repos/$REPO/collaborators/$PR_AUTHOR/permission" --jq '.permission')
             if [[ "$PERM" == "admin" || "$PERM" == "maintain" || "$PERM" == "write" ]]; then
                 echo "Author has trusted permission ($PERM). Allowed."
             else
                 echo "::notice::PR Author ($PR_AUTHOR) does not have sufficient permissions. Skipping."
                 exit 0
             fi
          fi

          # 3. Check for Review Comments (especially CodeRabbit feedback)
          echo "Checking for review comments in code..."

          # Get all review comments on code (inline comments with position/diff_hunk)
          # These are comments that reviewers leave on specific lines of code
          INLINE_REVIEW_COMMENTS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/comments" --paginate --jq '[.[] | select(.position != null or .original_position != null) | select(.user.login != "github-actions[bot]")] | length')

          # Check for CodeRabbit review comments specifically (both inline and general)
          CODERABBIT_INLINE=$(gh api "repos/$REPO/pulls/$PR_NUMBER/comments" --paginate --jq '[.[] | select(.user.login == "coderabbitai[bot]" and (.position != null or .original_position != null))] | length')

          # Also check for CodeRabbit review comments in PR comments (not just inline)
          CODERABBIT_PR_COMMENTS=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --paginate --jq '[.[] | select(.user.login == "coderabbitai[bot]" and (.body | test("suggestion|review|feedback|issue|problem|error|warning"; "i")))] | length')

          TOTAL_CODERABBIT_COMMENTS=$((CODERABBIT_INLINE + CODERABBIT_PR_COMMENTS))

          # If there are any inline review comments (from any reviewer, especially CodeRabbit), skip auto-merge
          if [[ "$INLINE_REVIEW_COMMENTS" -gt 0 ]] || [[ "$CODERABBIT_PR_COMMENTS" -gt 0 ]]; then
             echo "::notice::Review comments found ($INLINE_REVIEW_COMMENTS inline, $CODERABBIT_INLINE from CodeRabbit inline, $CODERABBIT_PR_COMMENTS from CodeRabbit PR comments). Auto-merge skipped."

             # Check if comment already exists to avoid duplicates
             COMMENT_EXISTS=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.body | contains("Auto-Merge Skipped") and contains("review comments")) | .id' | head -n 1)
             if [[ -z "$COMMENT_EXISTS" ]]; then
               # Post a comment explaining why auto-merge was skipped
               BODY=$'ðŸš« **Auto-Merge Skipped**\n\nAuto-merge was not executed because review comments were found in the code.\n\n'
               if [[ "$CODERABBIT_INLINE" -gt 0 ]] || [[ "$CODERABBIT_PR_COMMENTS" -gt 0 ]]; then
                 BODY+="CodeRabbit has left "
                 if [[ "$CODERABBIT_INLINE" -gt 0 ]] && [[ "$CODERABBIT_PR_COMMENTS" -gt 0 ]]; then
                   BODY+="$CODERABBIT_INLINE inline comment(s) and $CODERABBIT_PR_COMMENTS PR comment(s)"
                 elif [[ "$CODERABBIT_INLINE" -gt 0 ]]; then
                   BODY+="$CODERABBIT_INLINE inline comment(s)"
                 else
                   BODY+="$CODERABBIT_PR_COMMENTS PR comment(s)"
                 fi
                 BODY+=" that need to be addressed.\n\n"
               fi
               if [[ "$INLINE_REVIEW_COMMENTS" -gt 0 ]]; then
                 BODY+="There are $INLINE_REVIEW_COMMENTS inline review comment(s) in the code that need attention"
                 if [[ "$CODERABBIT_INLINE" -gt 0 ]]; then
                   BODY+=" ($CODERABBIT_INLINE from CodeRabbit)"
                 fi
                 BODY+=".\n\n"
               fi
               BODY+="Please review and address the feedback before merging.\n\n"
               BODY+="Once all review comments are resolved and CI workflows pass, auto-merge will proceed."
               gh pr comment "$PR_NUMBER" --body "$BODY"
             fi
             exit 0
          fi
          echo "No review comments found. Proceeding..."

          # 4. Check Coderabbit Status (approval or skip)
          echo "Checking Coderabbit status..."
          IS_APPROVED=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" --jq '.[] | select(.user.login == "coderabbitai[bot]" and .state == "APPROVED") | .state' | head -n 1)
          HAS_SKIP_COMMENT=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.user.login == "coderabbitai[bot]" and (.body | test("skip"; "i"))) | .id' | head -n 1)

          if [[ -n "$IS_APPROVED" ]]; then
             echo "Coderabbit APPROVED."
          elif [[ -n "$HAS_SKIP_COMMENT" ]]; then
             echo "Coderabbit SKIPPED review."
          else
             echo "::notice::Coderabbit has not approved or skipped yet. Waiting."
             exit 0
          fi

          # 5. Attempt Merge
          echo "All checks passed. Attempting auto-merge..."
          gh pr merge "$PR_NUMBER" --merge --auto --delete-branch
